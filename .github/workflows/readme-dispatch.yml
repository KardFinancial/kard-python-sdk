name: Dispatch doc sync to kard-core (README)

on:
  push:
    branches: [ main ]
    paths:
      - "README.md"
  workflow_dispatch:
    inputs:
      ref:
        description: "Source ref (branch, tag, or SHA)"
        required: false
        default: "main"

jobs:
  dispatch:
    runs-on: ubuntu-latest
    steps:
      - name: Dispatch event to kard-core
        env:
          GH_TOKEN: ${{ secrets.KARD_CORE_DISPATCH_TOKEN }}
          OWNER: KardFinancial
          TARGET_REPO: kard-core
          EVENT_TYPE: sdk-doc-updated
          SOURCE_REPO: kard-python-sdk
          SOURCE_REF: ${{ inputs.ref || github.ref_name }}
          SOURCE_SHA: ${{ github.sha }}
          SDK_ID: python-sdk
          DOC_TYPE: readme
        run: |
          set -euo pipefail

          curl -L -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/${OWNER}/${TARGET_REPO}/dispatches" \
            -d "$(jq -n \
              --arg event_type "${EVENT_TYPE}" \
              --arg source_repo "${SOURCE_REPO}" \
              --arg source_ref "${SOURCE_REF}" \
              --arg source_sha "${SOURCE_SHA}" \
              --arg sdk_id "${SDK_ID}" \
              --arg doc_type "${DOC_TYPE}" \
              '{event_type: $event_type, client_payload: {doc_type: $doc_type, sdk_id: $sdk_id, source_repo: $source_repo, source_ref: $source_ref, source_sha: $source_sha}}')"
